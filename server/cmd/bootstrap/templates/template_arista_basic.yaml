zabbix_export:
  version: '7.0'
  template_groups:
    - uuid: 1877cc163d5b46e1a8121d91b1dbe38e
      name: Templates/narvis
  templates:
    - uuid: 6072b993e70d4d5cb7234f6274f2b915
      template: template_arista_basic
      name: template_arista_basic
      description: |
        Template Net Arista
        
        MIBs used:
        ENTITY-SENSORS-MIB
        ENTITY-STATE-MIB
        IF-MIB
        EtherLike-MIB
        HOST-RESOURCES-MIB
        SNMPv2-MIB
        ENTITY-MIB
        
        Generated by official Zabbix template tool "Templator"
      templates:
        - name: template_interface_basic
      groups:
        - name: Templates/narvis
      items:
        - uuid: 05db7d8fbc254a809aa2742cf9882e84
          name: icmp_ping
          type: SIMPLE
          key: icmpping
          valuemap:
            name: 'Service state'
          triggers:
            - uuid: 3a0f3ec5b87d47e7b4c481f6c9730ad4
              expression: 'max(/template_arista_basic/icmpping,#3)=0'
              name: unavailable_by_icmp_ping
              priority: HIGH
              description: 'Last three attempts returned timeout.  Please check device connectivity.'
        - uuid: 7e3f56d7809d4dfdba03e285be823cf1
          name: icmp_loss
          type: SIMPLE
          key: icmppingloss
          value_type: FLOAT
          units: '%'
          triggers:
            - uuid: f1af3936cb164da7ba8b36b9eed29bc6
              expression: 'min(/template_arista_basic/icmppingloss,5m)>{$ICMP_LOSS_WARN} and min(/template_arista_basic/icmppingloss,5m)<100'
              name: high_icmp_ping_loss
              opdata: 'Loss: {ITEM.LASTVALUE1}'
              priority: WARNING
              dependencies:
                - name: unavailable_by_icmp_ping
                  expression: 'max(/template_arista_basic/icmpping,#3)=0'
        - uuid: 3e54b1e8f9e74d8791253b59fd6894ec
          name: icmp_response_time
          type: SIMPLE
          key: icmppingsec
          value_type: FLOAT
          units: s
          triggers:
            - uuid: 540b143f232c4ed998946a9d554c8d04
              expression: 'avg(/template_arista_basic/icmppingsec,5m)>{$ICMP_RESPONSE_TIME_WARN}'
              name: high_icmp_ping_response_time
              opdata: 'Value: {ITEM.LASTVALUE1}'
              priority: WARNING
              description: 'Average ICMP response time is too high.'
              dependencies:
                - name: high_icmp_ping_loss
                  expression: 'min(/template_arista_basic/icmppingloss,5m)>{$ICMP_LOSS_WARN} and min(/template_arista_basic/icmppingloss,5m)<100'
                - name: unavailable_by_icmp_ping
                  expression: 'max(/template_arista_basic/icmpping,#3)=0'
        - uuid: 2c507a5deeaa45d1ab88d39eb2682ee1
          name: get_sensors
          type: SNMP_AGENT
          snmp_oid: 'discovery[{#SENSOR_TYPE},1.3.6.1.2.1.99.1.1.1.1,{#SENSOR_INFO},1.3.6.1.2.1.47.1.1.1.1.2,{#SENSOR_PRECISION},1.3.6.1.2.1.99.1.1.1.3,{#THRESHOLD_LO_WARN},1.3.6.1.4.1.30065.3.12.1.1.1.1,{#THRESHOLD_LO_CRIT},1.3.6.1.4.1.30065.3.12.1.1.1.2,{#THRESHOLD_HI_WARN},1.3.6.1.4.1.30065.3.12.1.1.1.3,{#THRESHOLD_HI_CRIT},1.3.6.1.4.1.30065.3.12.1.1.1.4]'
          key: sensors.get
          delay: 1h
          history: '0'
          value_type: TEXT
          trends: '0'
          description: 'Gets sensors with type, description, and thresholds.'
          preprocessing:
            - type: JAVASCRIPT
              parameters:
                - |
                  try {
                  	var data = JSON.parse(value);
                  }
                  catch (error) {
                  	throw 'Failed to parse JSON of Arista sensor discovery.';
                  }
                  var fields = ['{#SNMPINDEX}','{#SENSOR_TYPE}','{#SENSOR_INFO}','{#SENSOR_PRECISION}','{#THRESHOLD_LO_WARN}','{#THRESHOLD_LO_CRIT}','{#THRESHOLD_HI_WARN}','{#THRESHOLD_HI_CRIT}'];
                  data.forEach(function (element) {
                  	fields.forEach(function (field) {
                  		element[field] = element[field] || '';
                  	});
                  });
                  return JSON.stringify(data);
        - uuid: d27038f133c74fb3a907e258a3a86e30
          name: cpu_utilization
          type: SNMP_AGENT
          snmp_oid: 'discovery[{#CPU.UTIL},1.3.6.1.2.1.25.3.3.1.2]'
          key: system.cpu.util
          delay: 3m
          value_type: FLOAT
          units: '%'
          description: |
            MIB: HOST-RESOURCES-MIB
            The average, over the last minute, of the percentage of time that processors was not idle.
            Implementations may approximate this one minute smoothing period if necessary.
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$..[''{#CPU.UTIL}''].avg()'
          triggers:
            - uuid: 79141250f2b04be893cce87bfa2287c0
              expression: 'min(/template_arista_basic/system.cpu.util,5m)>{$CPU.USAGE.HIGH}'
              name: high_cpu_utilization
              event_name: 'High CPU utilization (over {$CPU.UTIL.CRIT}% for 5m)'
              opdata: 'Current utilization: {ITEM.LASTVALUE1}'
              priority: WARNING
              description: 'CPU utilization is too high. The system might be slow to respond.'
        - uuid: 4d026ba76a5740bab97b2154db834bda
          name: uptime
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.2.1.1.3.0
          key: 'system.net.uptime[sysUpTime.0]'
          delay: 3m
          trends: '0'
          units: uptime
          description: |
            MIB: SNMPv2-MIB
            Time (in hundredths of a second) since the network management portion of the system was last re-initialized.
          preprocessing:
            - type: MULTIPLIER
              parameters:
                - '0.01'
        - uuid: d08871ed2d3e43dd8c308825c4a2394f
          name: snmp_agent_availability
          type: INTERNAL
          key: 'zabbix[host,snmp,available]'
          description: |
            Availability of SNMP checks on the host. The value of this item corresponds to availability icons in the host list.
            Possible values:
            0 - not available
            1 - available
            2 - unknown
          valuemap:
            name: zabbix.host.available
          triggers:
            - uuid: fd052cb3bb234e37826bf3ba7432489a
              expression: 'max(/template_arista_basic/zabbix[host,snmp,available],{$SNMP.TIMEOUT})=0'
              name: no_snmp_data_collection
              opdata: 'Current state: {ITEM.LASTVALUE1}'
              priority: WARNING
              description: 'SNMP is not available for polling. Please check device connectivity and SNMP settings.'
              dependencies:
                - name: unavailable_by_icmp_ping
                  expression: 'max(/template_arista_basic/icmpping,#3)=0'
      discovery_rules:
        - uuid: cfcb6741a1ff4be9be44f374b49fed94
          name: fan_discovery
          type: DEPENDENT
          key: fan.discovery
          delay: '0'
          filter:
            evaltype: OR
            conditions:
              - macro: '{#SENSOR_TYPE}'
                value: '10'
                formulaid: A
          description: 'ENTITY-SENSORS-MIB::EntitySensorDataType discovery with rpm filter'
          item_prototypes:
            - uuid: 3dc3020e02db4f47ad9d3f157b2a4f45
              name: fan_status
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.2.1.99.1.1.1.5.{#SNMPINDEX}'
              key: 'sensor.fan.status[entPhySensorOperStatus.{#SNMPINDEX}]'
              delay: 3m
              history: 7d
              trends: '0'
              description: |
                MIB: ENTITY-SENSORS-MIB
                The operational status of the sensor {#SENSOR_INFO}
              valuemap:
                name: 'ENTITY-SENSORS-MIB::EntitySensorStatus'
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - |
                      if (value == 3) {
                          return 2
                      } else {
                          return value
                      }
              tags:
                - tag: fan
                  value: '{#SENSOR_INFO}'
              trigger_prototypes:
                - uuid: 08308ea656804ee2bfeea1d1d2a4d31a
                  expression: 'min(/template_arista_basic/sensor.fan.status[entPhySensorOperStatus.{#SNMPINDEX}],#3:now-10m)>=2'
                  name: fan_status_abnormal
                  opdata: 'Current state: {ITEM.LASTVALUE1}'
                  priority: AVERAGE
                  description: 'Please check the fan unit'
                  manual_close: 'YES'
          master_item:
            key: sensors.get
          overrides:
            - name: 'trigger THRESHOLD_LO_WARN'
              step: '1'
              filter:
                conditions:
                  - macro: '{#THRESHOLD_LO_WARN}'
                    value: ^$
                    formulaid: A
              operations:
                - operationobject: TRIGGER_PROTOTYPE
                  operator: REGEXP
                  value: 'Fan speed is below the warning threshold'
                  discover: NO_DISCOVER
            - name: 'trigger THRESHOLD_LO_CRIT'
              step: '2'
              filter:
                conditions:
                  - macro: '{#THRESHOLD_LO_CRIT}'
                    value: ^$
                    formulaid: A
              operations:
                - operationobject: TRIGGER_PROTOTYPE
                  operator: REGEXP
                  value: 'Fan speed is below the critical threshold'
                  discover: NO_DISCOVER
            - name: 'trigger THRESHOLD_HI_WARN'
              step: '3'
              filter:
                conditions:
                  - macro: '{#THRESHOLD_HI_WARN}'
                    value: ^$
                    formulaid: A
              operations:
                - operationobject: TRIGGER_PROTOTYPE
                  operator: REGEXP
                  value: 'Fan speed is above the warning threshold'
                  discover: NO_DISCOVER
            - name: 'trigger THRESHOLD_HI_CRIT'
              step: '4'
              filter:
                conditions:
                  - macro: '{#THRESHOLD_HI_CRIT}'
                    value: ^$
                    formulaid: A
              operations:
                - operationobject: TRIGGER_PROTOTYPE
                  operator: REGEXP
                  value: 'Fan speed is above the critical threshold'
                  discover: NO_DISCOVER
        - uuid: a8f5d8b0bbe9409da5087026d99d6a3f
          name: psu_discovery
          type: SNMP_AGENT
          snmp_oid: 'discovery[{#ENT_CLASS},1.3.6.1.2.1.47.1.1.1.1.5,{#ENT_NAME},1.3.6.1.2.1.47.1.1.1.1.7]'
          key: psu.discovery
          delay: 1h
          filter:
            conditions:
              - macro: '{#ENT_CLASS}'
                value: '6'
                formulaid: A
          item_prototypes:
            - uuid: 487f2606a3bc4e7ebd25cf84934345da
              name: power_supply_status
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.2.1.131.1.1.1.3.{#SNMPINDEX}'
              key: 'sensor.psu.status[entStateOper.{#SNMPINDEX}]'
              delay: 3m
              trends: '0'
              description: 'MIB: ENTITY-STATE-MIB'
              valuemap:
                name: 'ENTITY-STATE-MIB::EntityOperState'
              tags:
                - tag: power
                  value: '{#ENT_NAME}'
              trigger_prototypes:
                - uuid: 4cc3aa7e79474193963a06c01dcde972
                  expression: 'min(/template_arista_basic/sensor.psu.status[entStateOper.{#SNMPINDEX}],#3:now-10m)>=2'
                  name: power_status_abnormal
                  opdata: 'Current state: {ITEM.LASTVALUE1}'
                  priority: AVERAGE
                  description: 'Please check the power supply unit for errors'
                  manual_close: 'YES'
          preprocessing:
            - type: JAVASCRIPT
              parameters:
                - |
                  if (value !=2) {
                      return 1
                  } else {
                      return 2
                  }
        - uuid: ad3a82c3aa724871af70aedc3db6f61a
          name: temperature_discovery
          type: DEPENDENT
          key: temp.discovery
          delay: '0'
          filter:
            evaltype: AND
            conditions:
              - macro: '{#SENSOR_PRECISION}'
                value: '1'
                formulaid: A
              - macro: '{#SENSOR_TYPE}'
                value: '8'
                formulaid: B
          description: 'ENTITY-SENSORS-MIB::EntitySensorDataType discovery with temperature filter'
          item_prototypes:
            - uuid: 957829f874824a3089aa3ed2e3722a3d
              name: temperature_status
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.2.1.99.1.1.1.5.{#SNMPINDEX}'
              key: 'sensor.temp.status[entPhySensorOperStatus.{#SNMPINDEX}]'
              delay: 3m
              history: 7d
              trends: '0'
              description: |
                MIB: ENTITY-SENSORS-MIB
                The operational status of the sensor {#SENSOR_INFO}
              valuemap:
                name: 'ENTITY-SENSORS-MIB::EntitySensorStatus'
              tags:
                - tag: entity
                  value: '{#SENSOR_INFO}'
            - uuid: 102f6c16581f486494db876a6dc640f9
              name: temperature
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.2.1.99.1.1.1.4.{#SNMPINDEX}'
              key: 'sensor.temp.value[entPhySensorValue.{#SNMPINDEX}]'
              delay: 3m
              history: 7d
              value_type: FLOAT
              trends: '0'
              units: °C
              description: |
                MIB: ENTITY-SENSORS-MIB
                The most recent measurement obtained by the agent for this sensor.
                To correctly interpret the value of this object, the associated entPhySensorType,
                entPhySensorScale, and entPhySensorPrecision objects must also be examined.
              preprocessing:
                - type: MULTIPLIER
                  parameters:
                    - '0.1'
              tags:
                - tag: entity
                  value: '{#SENSOR_INFO}'
              trigger_prototypes:
                - uuid: fa70f7e95a8e446c81f9aa19c3705bd4
                  expression: 'min(/template_arista_basic/sensor.temp.value[entPhySensorValue.{#SNMPINDEX}],5m) > {#THRESHOLD_HI_CRIT}'
                  name: high_temperature
                  event_name: '{#SENSOR_INFO}: Temperature is above the critical threshold of {#THRESHOLD_HI_CRIT}°C for 5m'
                  opdata: 'Current value: {ITEM.LASTVALUE1}'
                  priority: HIGH
                  description: 'This trigger uses temperature sensor values defined in the device.'
                - uuid: 286ac9e11b9e4e9fb670b3bb58d65237
                  expression: 'min(/template_arista_basic/sensor.temp.value[entPhySensorValue.{#SNMPINDEX}],5m) > {#THRESHOLD_HI_WARN}'
                  name: high_temperature
                  event_name: '{#SENSOR_INFO}: Temperature is above the warning threshold of {#THRESHOLD_HI_WARN}°C for 5m'
                  opdata: 'Current value: {ITEM.LASTVALUE1}'
                  priority: WARNING
                  description: 'This trigger uses temperature sensor values defined in the device.'
                  dependencies:
                    - name: high_temperature
                      expression: 'min(/template_arista_basic/sensor.temp.value[entPhySensorValue.{#SNMPINDEX}],5m) > {#THRESHOLD_HI_CRIT}'
          master_item:
            key: sensors.get
          overrides:
            - name: 'trigger THRESHOLD_LO_WARN'
              step: '1'
              filter:
                conditions:
                  - macro: '{#THRESHOLD_LO_WARN}'
                    value: ^$
                    formulaid: A
              operations:
                - operationobject: TRIGGER_PROTOTYPE
                  operator: REGEXP
                  value: 'Temperature is below the warning threshold'
                  discover: NO_DISCOVER
            - name: 'trigger THRESHOLD_LO_CRIT'
              step: '2'
              filter:
                conditions:
                  - macro: '{#THRESHOLD_LO_CRIT}'
                    value: ^$
                    formulaid: A
              operations:
                - operationobject: TRIGGER_PROTOTYPE
                  operator: REGEXP
                  value: 'Temperature is below the critical threshold'
                  discover: NO_DISCOVER
            - name: 'trigger THRESHOLD_HI_WARN'
              step: '3'
              filter:
                conditions:
                  - macro: '{#THRESHOLD_HI_WARN}'
                    value: ^$
                    formulaid: A
              operations:
                - operationobject: TRIGGER_PROTOTYPE
                  operator: REGEXP
                  value: 'Temperature is above the warning threshold'
                  discover: NO_DISCOVER
            - name: 'trigger THRESHOLD_HI_CRIT'
              step: '4'
              filter:
                conditions:
                  - macro: '{#THRESHOLD_HI_CRIT}'
                    value: ^$
                    formulaid: A
              operations:
                - operationobject: TRIGGER_PROTOTYPE
                  operator: REGEXP
                  value: 'Temperature is above the critical threshold'
                  discover: NO_DISCOVER
        - uuid: 71a4cb62dfcc4cd0b46c8d7e770597d7
          name: memory_discovery
          type: SNMP_AGENT
          snmp_oid: 'discovery[{#MEMNAME},1.3.6.1.2.1.25.2.3.1.3,{#MEMTYPE},1.3.6.1.2.1.25.2.3.1.2,{#ALLOC_UNITS},1.3.6.1.2.1.25.2.3.1.4]'
          key: vm.memory.discovery
          delay: 1h
          filter:
            evaltype: AND
            conditions:
              - macro: '{#MEMNAME}'
                value: '{$MEMORY.NAME.MATCHES}'
                formulaid: A
              - macro: '{#MEMNAME}'
                value: '{$MEMORY.NAME.NOT_MATCHES}'
                operator: NOT_MATCHES_REGEX
                formulaid: B
              - macro: '{#MEMTYPE}'
                value: '{$MEMORY.TYPE.MATCHES}'
                formulaid: C
              - macro: '{#MEMTYPE}'
                value: '{$MEMORY.TYPE.NOT_MATCHES}'
                operator: NOT_MATCHES_REGEX
                formulaid: D
          description: 'HOST-RESOURCES-MIB::hrStorage discovery with memory filter'
          item_prototypes:
            - uuid: 8823dfd8524b4009bac9210f1dbc0cad
              name: total_memory
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.2.1.25.2.3.1.5.{#SNMPINDEX}'
              key: 'vm.memory.total[hrStorageSize.{#SNMPINDEX}]'
              delay: 3m
              history: 7d
              trends: '0'
              units: B
              description: |
                MIB: HOST-RESOURCES-MIB
                The size of the storage represented by this entry, in units of hrStorageAllocationUnits.
                This object is writable to allow remote configuration of the size of the storage area in those cases where such an operation makes sense and is possible on the underlying system.
                For example, the amount of main memory allocated to a buffer pool might be modified or the amount of disk space allocated to virtual memory might be modified.
              preprocessing:
                - type: MULTIPLIER
                  parameters:
                    - '{#ALLOC_UNITS}'
            - uuid: 7cf67c482abf4545a60331a06cde44fd
              name: free_memory
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.2.1.25.2.3.1.6.{#SNMPINDEX}'
              key: 'vm.memory.used[hrStorageUsed.{#SNMPINDEX}]'
              delay: 3m
              history: 7d
              trends: '0'
              units: B
              description: |
                MIB: HOST-RESOURCES-MIB
                The amount of the storage represented by this entry that is allocated, in units of hrStorageAllocationUnits.
              preprocessing:
                - type: MULTIPLIER
                  parameters:
                    - '{#ALLOC_UNITS}'
            - uuid: d574f9fbea2d409cadfeb36e85b9b7c1
              name: memory_utlization
              type: CALCULATED
              key: 'vm.memory.util[memoryUsedPercentage.{#SNMPINDEX}]'
              delay: 3m
              history: 7d
              value_type: FLOAT
              trends: '0'
              units: '%'
              params: 'last(//vm.memory.used[hrStorageUsed.{#SNMPINDEX}])/last(//vm.memory.total[hrStorageSize.{#SNMPINDEX}])*100'
              description: 'Memory utilization in %.'
              tags:
                - tag: entity
                  value: '{#MEMNAME},'
              trigger_prototypes:
                - uuid: 03846560636449348c827a91170ae40e
                  expression: 'min(/template_arista_basic/vm.memory.util[memoryUsedPercentage.{#SNMPINDEX}],5m)>{$MEMORY.UTIL.HIGH}'
                  name: high_memory_utilization
                  event_name: '{#MEMNAME}: High memory utilization (>{$MEMORY.UTIL.MAX}% for 5m)'
                  priority: AVERAGE
                  description: 'The system is running out of free memory.'
                  manual_close: 'YES'
      macros:
        - macro: '{$CPU.USAGE.HIGH}'
          value: '90'
        - macro: '{$ICMP_LOSS_WARN}'
          value: '20'
        - macro: '{$ICMP_RESPONSE_TIME_WARN}'
          value: '0.15'
        - macro: '{$MEMORY.UTIL.HIGH}'
          value: '90'
        - macro: '{$SNMP.TIMEOUT}'
          value: 5m
        - macro: '{$TEMP_CRIT}'
          value: '75'
      valuemaps:
        - uuid: 041108d95baf448dab366d063c81c5e3
          name: 'ENTITY-SENSORS-MIB::EntitySensorStatus'
          mappings:
            - value: '1'
              newvalue: ok
            - value: '2'
              newvalue: unavailable
            - value: '3'
              newvalue: nonoperational
        - uuid: 2136034283294cdc924e18d7f54a8a2e
          name: 'ENTITY-STATE-MIB::EntityOperState'
          mappings:
            - value: '1'
              newvalue: unknown
            - value: '2'
              newvalue: disabled
            - value: '3'
              newvalue: enabled
            - value: '4'
              newvalue: testing
        - uuid: f11b287af61a48ff84539d495bfc8296
          name: 'EtherLike-MIB::dot3StatsDuplexStatus'
          mappings:
            - value: '1'
              newvalue: unknown
            - value: '2'
              newvalue: halfDuplex
            - value: '3'
              newvalue: fullDuplex
        - uuid: fd00db13f4d34bc7a2a4644227bbc2ae
          name: 'IF-MIB::ifOperStatus'
          mappings:
            - value: '1'
              newvalue: up
            - value: '2'
              newvalue: down
            - value: '4'
              newvalue: unknown
            - value: '5'
              newvalue: dormant
            - value: '6'
              newvalue: notPresent
            - value: '7'
              newvalue: lowerLayerDown
        - uuid: e1adaf05bfb446eaaa9098c03107f1a5
          name: 'Service state'
          mappings:
            - value: '0'
              newvalue: Down
            - value: '1'
              newvalue: Up
        - uuid: 7154014d74b748af8d66b70de2827404
          name: zabbix.host.available
          mappings:
            - value: '0'
              newvalue: 'not available'
            - value: '1'
              newvalue: available
            - value: '2'
              newvalue: unknown
